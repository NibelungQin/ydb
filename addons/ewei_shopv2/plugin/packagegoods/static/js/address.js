// eval(function(p,a,c,k,e,d){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--){d[e(c)]=k[c]||e(c)}k=[function(e){return d[e]}];e=function(){return'\\w+'};c=1};while(c--){if(k[c]){p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c])}}return p}('22([\'H\',\'M\'],9(H,M){3 K={};K.23=9(){5(V(7.e)!==\'10\'){3 6=$(".4-6[8-r=\'"+7.e.f+"\']");5(6.A<=\'0\'){3 U=$(".4-6");5(U.A>\'0\'){3 a=M(\'1k\',{4:7.e});$(U).U().2j(a)}u{7.e.27=1;3 a=M(\'1k\',{4:7.e});$(\'.W-1s\').29();$(\'.x-W\').a(a)}}u{3 4=7.e;6.o(\'.n\').a(4.n);6.o(\'.j\').a(4.j);6.o(\'.4\').a(4.d.1w(/ /1A,\'\')+\' \'+4.4)}N 7.e}$(\'*[8-1q=N]\').2b(\'I\').I(9(){3 6=$(p).15(\'.4-6\');3 f=6.8(\'r\');g.2f(\'删除后无法恢复, 确认要删除吗 ?\',9(){H.w(\'X/4/N\',{f:f},9(z){5(z.1f==1){5(z.F.1r){$("[8-r=\'"+z.F.1r+"\']").o(\':1T\').1S(\'1B\',y)}6.1t();2c(9(){5($(".4-6").A<=0){$(\'.W-1s\').k()}},2a);h}g.l.k(z.F.1h)},y,y)})});$(L).17(\'I\',\'[8-1q=1p]\',9(){3 6=$(p).15(\'.4-6\');3 f=6.8(\'r\');H.w(\'X/4/1p\',{f:f},9(z){5(z.1f==1){$(\'.x-W\').1l(6);g.l.k("设置默认地址成功");h}g.l.k(z.F.1h)},y,y)})};K.2d=9(s){3 1i=[\'1j.1n\'];5(s.O){1i=[\'1j.1n\',\'1j.2i\']}2h(1i,9(){$(\'#d\').1g({1c:\'请选择所在城市\',O:s.O,Y:s.Y,26:9(2g){3 G=$(\'#d\').E(\'8-C\');3 J=G.1z(\' \');5(s.O&&s.Y){3 q=J[1];3 v=J[2];q=q+\'\';v=v+\'\';3 8=18(q,v);3 b=$(\'<1o 2k="1E" f="b"  1G="b" 8-C="" C="" 24="所在街道"  1U="x-1o" 1Y=""/>\');3 1u=$(\'#b\').15(\'.x-1W-1V\');$(\'#b\').1t();1u.1Z(b);b.1g({1c:\'请选择所在街道\',b:1,8:8})}}});5(s.O&&s.Y){3 G=$(\'#d\').E(\'8-C\');5(G){3 J=G.1z(\' \');3 q=J[1];3 v=J[2];3 8=18(q,v);$(\'#b\').1g({1c:\'请选择所在街道\',b:1,8:8})}}});$(L).17(\'I\',\'#14-4\',9(){2Q.2l({2S:9(D){$("#n").c(D.2R);$(\'#j\').c(D.2L);$(\'#4\').c(D.2T);$(\'#d\').c(D.2J+" "+D.2K+" "+D.2H)}})});$(L).17(\'I\',\'#14-B\',9(){5($(p).E(\'B\')){h}5($(\'#n\').16()){g.l.k("请填写收件人");h}3 1y=/(境外地区)+/.13($(\'#d\').c());3 1x=/(台湾)+/.13($(\'#d\').c());3 1m=/(澳门)+/.13($(\'#d\').c());3 1v=/(香港)+/.13($(\'#d\').c());5(1y||1x||1m||1v){5($(\'#j\').16()){g.l.k("请填写手机号码");h}}u{5(!$(\'#j\').2G()){g.l.k("请填写正确手机号码");h}}5($(\'#d\').16()){g.l.k("请填写所在地区");h}5($(\'#4\').16()){g.l.k("请填写详细地址");h}$(\'#14-B\').a(\'正在处理...\').E(\'B\',1);7.e={n:$(\'#n\').c(),j:$(\'#j\').c(),4:$(\'#4\').c(),d:$(\'#d\').c(),b:$(\'#b\').c(),2E:$(\'#b\').E(\'8-C\'),G:$(\'#d\').E(\'8-C\')};H.w(\'X/4/B\',{f:$(\'#r\').c(),2q:7.e},9(w){$(\'#14-B\').a(\'保存地址\').2m(\'B\');7.e.f=w.F.r;5(w.1f==1){g.l.k(\'保存成功!\');1P.1Q()}u{g.l.k(w.F.1h)}},y,y)})};K.2C=9(){5(V(7.e)!==\'10\'){3 4=7.e;3 6=$(".4-6[8-r=\'"+4.f+"\']",$(\'#1e-4-Q\'));5(6.A>0){6.o(\'.n\').a(4.n);6.o(\'.j\').a(4.j);6.o(\'.4\').a(4.d.1w(/ /1A,\'\')+\' \'+4.4)}u{3 a=M(\'1k\',{4:7.e});$(\'.x-12-2x\').1l(a)}N 7.e}3 P=1d;5(V(7.T)!==\'10\'){P=7.T.f;N 7.T}u 5(V(7.1K)!==\'10\'){P=7.1K}5(P){$(".4-6[8-r=\'"+P+"\'] .x-1T",$(\'#1e-4-Q\')).1S(\'1B\',y)}$(\'.4-6 .x-12-2y,.4-6 .x-12-2w\',$(\'#1e-4-Q\')).I(9(){3 $p=$(p).15(\'.4-6\');7.T={\'n\':$p.o(\'.n\').a(),\'4\':$p.o(\'.4\').a(),\'j\':$p.o(\'.j\').a(),\'f\':$p.8(\'r\')};1P.1Q()})};K.2z=9(){H.w(\'X/4/Q/2A\',{},9(){})};7.1L=9(11){3 t=1b;5(7.1R){t=1O 1R("2B.2v");t.2u=1d;t.2o(11)||t.2n(11)}u 5(L.1F&&L.1F.2p){3 Z=1O 7.2t();Z.2s("2D",11,1d);Z.2O(1b);t=Z.2N}u{t=1b}h t};7.18=9(q,v){3 1J=q.2P(0,2);3 1M=\'../2M/2F/2I/2r/2e/21/12/\'+1J+\'/\'+q+\'.20\';3 1I=1L(1M);3 S=1I.1X[0].1D("R");3 8=[];5(S.A>0){1C(3 i=0;i<S.A;i++){3 R=S[i];3 1H=R.19("1N");5(1H==v){3 1a=R.1D("b");1C(3 m=0;m<1a.A;m++){3 b=1a[m];8.28({"1E":b.19(\'1G\'),"C":b.19(\'1N\'),"25":[]})}}}}h 8};h K});',62,180,'|||var|address|if|item|window|data|function|html|street|val|areas|editAddressData|id|FoxUI|return||mobile|show|toast||realname|find|this|city_code|addressid|params|xmlDom|else|area_code|json|fui|true|ret|length|submit|value|res|attr|result|datavalue|core|click|codes|modal|document|tpl|delete|new_area|selectedAddressID|selector|county|CityList|selectedAddressData|first|typeof|content|member|address_street|xmlhttp|undefined|xmlFile|list|test|btn|closest|isEmpty|on|loadStreetData|getAttribute|streetlist|null|title|false|page|status|cityPicker|message|reqParams|foxui|tpl_address_item|prepend|aomen|picker|input|setdefault|toggle|defaultid|empty|remove|parents|xianggang|replace|taiwan|jingwai|split|ig|checked|for|getElementsByTagName|text|implementation|name|county_code|xmlCityDoc|left|orderSelectedAddressID|loadXmlFile|xmlUrl|code|new|history|back|ActiveXObject|prop|radio|class|info|cell|childNodes|readonly|append|xml|area|define|initList|placeholder|children|onClose|isdefault|push|hide|100|unbind|setTimeout|initPost|dist|confirm|self|require|citydatanew|before|type|openAddress|removeAttr|loadXML|load|createDocument|addressdata|js|open|XMLHttpRequest|async|XMLDOM|inner|group|media|loadSelectorData|get_list|Microsoft|initSelector|GET|streetdatavalue|ewei_shopv2|isMobile|countryName|static|provinceName|cityName|telNumber|addons|responseXML|send|substring|wx|userName|success|detailInfo'.split('|'),0,{}))


define(['core', 'tpl'],
    function(core, tpl) {
        var modal = {};
        modal.initList = function() {
            if (typeof(window.editAddressData) !== 'undefined') {
                var item = $(".address-item[data-addressid='" + window.editAddressData.id + "']");
                if (item.length <= '0') {
                    var first = $(".address-item");
                    if (first.length > '0') {
                        var html = tpl('tpl_address_item', {
                            address: window.editAddressData
                        });
                        $(first).first().before(html)
                    } else {
                        window.editAddressData.isdefault = 1;
                        var html = tpl('tpl_address_item', {
                            address: window.editAddressData
                        });
                        $('.content-empty').hide();
                        $('.fui-content').html(html)
                    }
                } else {
                    var address = window.editAddressData;
                    item.find('.realname').html(address.realname);
                    item.find('.mobile').html(address.mobile);
                    item.find('.address').html(address.areas.replace(/ /ig, '') + ' ' + address.address)
                }
                delete window.editAddressData
            }
            $('*[data-toggle=delete]').unbind('click').click(function() {
                var item = $(this).closest('.address-item');
                var id = item.data('addressid');
                FoxUI.confirm('删除后无法恢复, 确认要删除吗 ?',
                    function() {
                        core.json('member/address/delete', {
                                id: id
                            },
                            function(ret) {
                                if (ret.status == 1) {
                                    if (ret.result.defaultid) {
                                        $("[data-addressid='" + ret.result.defaultid + "']").find(':radio').prop('checked', true)
                                    }
                                    item.remove();
                                    setTimeout(function() {
                                            if ($(".address-item").length <= 0) {
                                                $('.content-empty').show()
                                            }
                                        },
                                        100);
                                    return
                                }
                                FoxUI.toast.show(ret.result.message)
                            },
                            true, true)
                    })
            });
            $(document).on('click', '[data-toggle=setdefault]',
                function() {
                    var item = $(this).closest('.address-item');
                    var id = item.data('addressid');
                    core.json('member/address/setdefault', {
                            id: id
                        },
                        function(ret) {
                            if (ret.status == 1) {
                                $('.fui-content').prepend(item);
                                FoxUI.toast.show("设置默认地址成功");
                                return
                            }
                            FoxUI.toast.show(ret.result.message)
                        },
                        true, true)
                })
        };
        modal.initPost = function(params) {
            var reqParams = ['foxui.picker'];
            if (params.new_area) {
                reqParams = ['foxui.picker', 'foxui.citydatanew']
            }
            require(reqParams,
                function() {
                    $('#areas').cityPicker({
                        title: '请选择所在城市',
                        new_area: params.new_area,
                        address_street: params.address_street,
                        onClose: function(self) {
                            var datavalue = $('#areas').attr('data-value');
                            var codes = datavalue.split(' ');
                            if (params.new_area && params.address_street) {
                                var city_code = codes[1];
                                var area_code = codes[2];
                                city_code = city_code + '';
                                area_code = area_code + '';
                                var data = loadStreetData(city_code, area_code);
                                var street = $('<input type="text" id="street"  name="street" data-value="" value="" placeholder="所在街道"  class="fui-input" readonly=""/>');
                                var parents = $('#street').closest('.fui-cell-info');
                                $('#street').remove();
                                parents.append(street);
                                street.cityPicker({
                                    title: '请选择所在街道',
                                    street: 1,
                                    data: data
                                })
                            }
                        }
                    });
                    if (params.new_area && params.address_street) {
                        var datavalue = $('#areas').attr('data-value');
                        if (datavalue) {
                            var codes = datavalue.split(' ');
                            var city_code = codes[1];
                            var area_code = codes[2];
                            var data = loadStreetData(city_code, area_code);
                            $('#street').cityPicker({
                                title: '请选择所在街道',
                                street: 1,
                                data: data
                            })
                        }
                    }
                });
            $(document).on('click', '#btn-address',
                function() {
                    wx.openAddress({
                        success: function(res) {
                            $("#realname").val(res.userName);
                            $('#mobile').val(res.telNumber);
                            $('#address').val(res.detailInfo);
                            $('#areas').val(res.provinceName + " " + res.cityName + " " + res.countryName)
                        }
                    })
                });
            $(document).on('click', '#btn-submit',
                function() {
                    if ($(this).attr('submit')) {
                        return
                    }
                    if ($('#realname').isEmpty()) {
                        FoxUI.toast.show("请填写收件人");
                        return
                    }
                    var jingwai = /(境外地区)+/.test($('#areas').val());
                    var taiwan = /(台湾)+/.test($('#areas').val());
                    var aomen = /(澳门)+/.test($('#areas').val());
                    var xianggang = /(香港)+/.test($('#areas').val());
                    if (jingwai || taiwan || aomen || xianggang) {
                        if ($('#mobile').isEmpty()) {
                            FoxUI.toast.show("请填写手机号码");
                            return
                        }
                    } else {
                        if (!$('#mobile').isMobile()) {
                            FoxUI.toast.show("请填写正确手机号码");
                            return
                        }
                    }
                    if ($('#areas').isEmpty()) {
                        FoxUI.toast.show("请填写所在地区");
                        return
                    }
                    if ($('#address').isEmpty()) {
                        FoxUI.toast.show("请填写详细地址");
                        return
                    }
                    $('#btn-submit').html('正在处理...').attr('submit', 1);
                    window.editAddressData = {
                        realname: $('#realname').val(),
                        mobile: $('#mobile').val(),
                        address: $('#address').val(),
                        areas: $('#areas').val(),
                        street: $('#street').val(),
                        streetdatavalue: $('#street').attr('data-value'),
                        datavalue: $('#areas').attr('data-value')
                    };
                    core.json('member/address/submit', {
                            id: $('#addressid').val(),
                            addressdata: window.editAddressData
                        },
                        function(json) {
                            $('#btn-submit').html('保存地址').removeAttr('submit');
                            window.editAddressData.id = json.result.addressid;
                            if (json.status == 1) {
                                FoxUI.toast.show('保存成功!');
                                history.back()
                            } else {
                                FoxUI.toast.show(json.result.message)
                            }
                        },
                        true, true)
                })
        };
        modal.initSelector = function() {
            if (typeof(window.editAddressData) !== 'undefined') {
                var address = window.editAddressData;
                var item = $(".address-item[data-addressid='" + address.id + "']", $('#page-address-selector'));
                if (item.length > 0) {
                    item.find('.realname').html(address.realname);
                    item.find('.mobile').html(address.mobile);
                    item.find('.address').html(address.areas.replace(/ /ig, '') + ' ' + address.address)
                } else {
                    var html = tpl('tpl_address_item', {
                        address: window.editAddressData
                    });
                    $('.fui-list-group').prepend(html)
                }
                delete window.editAddressData
            }
            var selectedAddressID = false;
            if (typeof(window.selectedAddressData) !== 'undefined') {
                selectedAddressID = window.selectedAddressData.id;
                delete window.selectedAddressData
            } else if (typeof(window.orderSelectedAddressID) !== 'undefined') {
                selectedAddressID = window.orderSelectedAddressID
            }
            if (selectedAddressID) {
                $(".address-item[data-addressid='" + selectedAddressID + "'] .fui-radio", $('#page-address-selector')).prop('checked', true)
            }
            $('.address-item .fui-list-media,.address-item .fui-list-inner', $('#page-address-selector')).click(function() {
                var $this = $(this).closest('.address-item');
                window.selectedAddressData = {
                    'realname': $this.find('.realname').html(),
                    'address': $this.find('.address').html(),
                    'mobile': $this.find('.mobile').html(),
                    'id': $this.data('addressid')
                };
                history.back()
            })
        };
        modal.loadSelectorData = function() {
            core.json('member/address/selector/get_list', {},
                function() {})
        };
        window.loadXmlFile = function(xmlFile) {
            var xmlDom = null;
            if (window.ActiveXObject) {
                xmlDom = new ActiveXObject("Microsoft.XMLDOM");
                xmlDom.async = false;
                xmlDom.load(xmlFile) || xmlDom.loadXML(xmlFile)
            } else if (document.implementation && document.implementation.createDocument) {
                var xmlhttp = new window.XMLHttpRequest();
                xmlhttp.open("GET", xmlFile, false);
                xmlhttp.send(null);
                xmlDom = xmlhttp.responseXML
            } else {
                xmlDom = null
            }
            return xmlDom
        };
        window.loadStreetData = function(city_code, area_code) {
            var left = city_code.substring(0, 2);
            var xmlUrl = '../addons/ewei_shopv2/static/js/dist/area/list/' + left + '/' + city_code + '.xml';
            var xmlCityDoc = loadXmlFile(xmlUrl);
            var CityList = xmlCityDoc.childNodes[0].getElementsByTagName("county");
            var data = [];
            if (CityList.length > 0) {
                for (var i = 0; i < CityList.length; i++) {
                    var county = CityList[i];
                    var county_code = county.getAttribute("code");
                    if (county_code == area_code) {
                        var streetlist = county.getElementsByTagName("street");
                        for (var m = 0; m < streetlist.length; m++) {
                            var street = streetlist[m];
                            data.push({
                                "text": street.getAttribute('name'),
                                "value": street.getAttribute('code'),
                                "children": []
                            })
                        }
                    }
                }
            }
            return data
        };
        return modal
    });